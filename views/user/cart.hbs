<section>
  <div class="container">
    <table class="table mt-5">
      <thead>
        <tr>
          <th scope="col">Item</th>
          <th scope="col">Title</th>
          <th scope="col">Price</th>
          <th scope="col">Quantity</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {{#each products}}
        <tr id="row-{{this.product._id}}">
          <td><img style="width:70px; height:70px" src="/product-images/{{this.product._id}}.jpg" alt=""></td>
          <td>{{this.product.Name}}</td>
          <td id="total-{{this.product._id}}">Rs {{this.totalPrice}}</td>
          <td>
            <button class="cart-item-count mr-3"
              onclick="changeQuantity('{{this._id}}','{{this.product._id}}','{{this.product.Price}}',-1)">-</button>

            <span id="qty-{{this.product._id}}">{{this.quantity}}</span>

            <button class="cart-item-count ml-3"
              onclick="changeQuantity('{{this._id}}','{{this.product._id}}','{{this.product.Price}}',1)">+</button>
          </td>
          <td>
            <button class="btn btn-danger" onclick="removeProduct('{{this._id}}','{{this.product._id}}')">
              Remove
            </button>
          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
    <hr>
    <div class="float-right pr-5">
      <h3>Grand Total: Rs <span id="grand-total">{{grandTotal}}</span></h3>
      <a href="/place-order" class="btn btn-success mt-3" style="width:100%;"><b>Place Order</b></a>
    </div>
  </div>
</section>

<script>
  // Helper function to recalc grand total
  function updateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll('[id^="total-"]').forEach(el => {
      let val = parseFloat(el.innerText.replace('Rs ', '')) || 0;
      grandTotal += val;
    });
    document.getElementById('grand-total').innerText = grandTotal.toFixed(2);
  }

  function changeQuantity(cartId, proId, price, count) {
    price = parseFloat(price);
    let qtyEl = document.getElementById(`qty-${proId}`);
    let quantity = parseInt(qtyEl.innerText);
    quantity += parseInt(count);

    if (quantity < 0) quantity = 0; // prevent negative quantities
    qtyEl.innerText = quantity;

    let totalEl = document.getElementById(`total-${proId}`);
    totalEl.innerText = `Rs ${(quantity * price).toFixed(2)}`;

    updateGrandTotal();

    // optional: send ajax to update backend asynchronously
    $.post('/change-product-quantity', { cart: cartId, product: proId, count: count, quantity: quantity });
  }

  function removeProduct(cartId, proId) {
    const $row = $('#row-' + proId);
    $row.remove();
    updateGrandTotal();

    // optional: notify backend
    $.post('/remove-product', { cart: cartId, product: proId });
  }

  // recalc grand total on page load just in case
  updateGrandTotal();
</script>
